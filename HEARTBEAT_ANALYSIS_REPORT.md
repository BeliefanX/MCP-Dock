# MCP-Dock å¿ƒè·³æœºåˆ¶å…¨é¢åˆ†æå’Œä¼˜åŒ–æŠ¥å‘Š

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ MCP-Dock é¡¹ç›®çš„å¿ƒè·³æœºåˆ¶è¿›è¡Œäº†å…¨é¢åˆ†æå’Œä¼˜åŒ–ï¼Œé‡ç‚¹è§£å†³äº†æ—¥å¿—ä¿¡æ¯ä¸è¶³ã€åè®®è¦†ç›–ä¸å…¨ã€æ€§èƒ½ç›‘æ§ç¼ºå¤±ç­‰å…³é”®é—®é¢˜ã€‚é€šè¿‡å®æ–½åˆ†é˜¶æ®µä¼˜åŒ–æ–¹æ¡ˆï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œç¨³å®šæ€§ã€‚

## ğŸ” å½“å‰å®ç°åˆ†æ

### åŸæœ‰å¿ƒè·³æœºåˆ¶æ¦‚å†µ

**å®ç°ä½ç½®ï¼š**
- ä¸»è¦åœ¨ `mcp_dock/api/routes/dynamic_proxy.py` ä¸­å®ç°
- ä»…é’ˆå¯¹ SSE åè®®æä¾›å¿ƒè·³åŠŸèƒ½
- åŸºç¡€çš„ä¼šè¯ç®¡ç†åœ¨ `mcp_dock/core/sse_session_manager.py`

**å…³é”®å‚æ•°ï¼š**
- å¿ƒè·³é—´éš”ï¼š10 ç§’ï¼ˆç¡¬ç¼–ç ï¼‰
- æ£€æŸ¥é¢‘ç‡ï¼š1 ç§’
- æ—¥å¿—é¢‘ç‡ï¼šæ¯åˆ†é’Ÿè®°å½•ä¸€æ¬¡
- ä¼šè¯è¶…æ—¶ï¼š5 åˆ†é’Ÿ
- æ¸…ç†é—´éš”ï¼š5 åˆ†é’Ÿ

### å‘ç°çš„é—®é¢˜

#### P1 - å…³é”®é—®é¢˜
1. **æ—¥å¿—ä¿¡æ¯ä¸¥é‡ä¸è¶³**
   - ä»…è®°å½• session IDï¼Œç¼ºä¹ä¸Šä¸‹æ–‡ä¿¡æ¯
   - æ— å®¢æˆ·ç«¯ IPã€ç”¨æˆ·ä»£ç†ã€è¿æ¥æ—¶é—´ç­‰å…³é”®ä¿¡æ¯
   - ç¼ºä¹æ€§èƒ½æŒ‡æ ‡å’Œå¥åº·åº¦ç»Ÿè®¡

2. **åè®®è¦†ç›–ä¸å®Œæ•´**
   - å¿ƒè·³æœºåˆ¶ä»…é€‚ç”¨äº SSE åè®®
   - stdio å’Œ streamableHTTP åè®®ç¼ºä¹ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥
   - ä¸åŒåè®®é—´ç¼ºä¹ä¸€è‡´çš„ç›‘æ§æ ‡å‡†

3. **æ€§èƒ½ç›‘æ§ç¼ºå¤±**
   - æ— å“åº”æ—¶é—´ç»Ÿè®¡
   - æ— å»¶è¿Ÿå’Œé”™è¯¯ç‡ç›‘æ§
   - ç¼ºä¹ç³»ç»Ÿè´Ÿè½½æ„ŸçŸ¥èƒ½åŠ›

#### P2 - æ¬¡è¦é—®é¢˜
1. **é…ç½®ç®¡ç†ä¸çµæ´»**
   - å¿ƒè·³å‚æ•°ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
   - æ— æ³•åŠ¨æ€è°ƒæ•´é…ç½®
   - ç¼ºä¹ç¯å¢ƒç‰¹å®šçš„é…ç½®æ”¯æŒ

2. **èµ„æºä½¿ç”¨æœªä¼˜åŒ–**
   - å›ºå®šé¢‘ç‡æ£€æŸ¥å¯èƒ½é€ æˆèµ„æºæµªè´¹
   - ç¼ºä¹è‡ªé€‚åº”è°ƒæ•´æœºåˆ¶
   - é«˜è´Ÿè½½æ—¶æ— é™çº§ç­–ç•¥

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆå®æ–½

### é˜¶æ®µ 1ï¼šå¿ƒè·³æ—¥å¿—å¢å¼º âœ…

**å®æ–½å†…å®¹ï¼š**
1. **å¢å¼ºæ—¥å¿—ä¿¡æ¯**
   - æ·»åŠ å®¢æˆ·ç«¯ IP åœ°å€å’Œç”¨æˆ·ä»£ç†ä¿¡æ¯
   - åŒ…å«ä¼šè¯å¹´é¾„å’Œå¾…å¤„ç†æ¶ˆæ¯æ•°é‡
   - é›†æˆç»“æ„åŒ–æ—¥å¿—è®°å½•

2. **æ€§èƒ½æŒ‡æ ‡é›†æˆ**
   - å“åº”æ—¶é—´æµ‹é‡
   - é”™è¯¯ç‡ç»Ÿè®¡
   - ä¼šè¯å¥åº·åº¦è¯„ä¼°

**ä»£ç å˜æ›´ï¼š**
```python
# å¢å¼ºçš„å¿ƒè·³æ—¥å¿—è®°å½•
log_mcp_request(
    logger, 
    logging.INFO,
    f"SSE heartbeat #{heartbeat_count//2}",
    request_id=session_id,
    method="notifications/ping",
    protocol_version="2025-03-26",
    client_ip=client_ip,
    user_agent=user_agent[:50] + "..." if len(user_agent) > 50 else user_agent,
    proxy_name=actual_proxy_name,
    session_age_seconds=round(session_age, 1),
    pending_messages=pending_count,
    transport_type="sse",
    heartbeat_interval_seconds=10
)
```

### é˜¶æ®µ 2ï¼šé…ç½®åŒ–ç®¡ç† âœ…

**æ–°å¢é…ç½®æ–‡ä»¶ï¼š**
- `mcp_dock/config/heartbeat.config.json` - å¿ƒè·³é…ç½®
- æ”¯æŒæ€§èƒ½ç›‘æ§ã€è‡ªé€‚åº”å¿ƒè·³ã€åè®®ç‰¹å®šè®¾ç½®

**é…ç½®ç»“æ„ï¼š**
```json
{
  "heartbeat_interval_seconds": 10,
  "performance_monitoring": {
    "enabled": true,
    "response_time_threshold_ms": 1000,
    "error_rate_threshold_percent": 5
  },
  "adaptive_heartbeat": {
    "enabled": true,
    "min_interval_seconds": 5,
    "max_interval_seconds": 30
  }
}
```

### é˜¶æ®µ 3ï¼šå¿ƒè·³ç®¡ç†å™¨ âœ…

**æ–°å¢æ ¸å¿ƒç»„ä»¶ï¼š**
- `mcp_dock/core/heartbeat_manager.py` - ç»Ÿä¸€å¿ƒè·³ç®¡ç†
- æ”¯æŒè‡ªé€‚åº”é—´éš”è°ƒæ•´
- é›†æˆæ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†

**å…³é”®åŠŸèƒ½ï¼š**
1. **è‡ªé€‚åº”å¿ƒè·³é—´éš”**
   - åŸºäºé”™è¯¯ç‡åŠ¨æ€è°ƒæ•´
   - å“åº”æ—¶é—´æ„ŸçŸ¥
   - ç³»ç»Ÿè´Ÿè½½é€‚åº”

2. **æ€§èƒ½æŒ‡æ ‡æ”¶é›†**
   - å“åº”æ—¶é—´ç»Ÿè®¡
   - æˆåŠŸç‡ç›‘æ§
   - é”™è¯¯æ¨¡å¼åˆ†æ

### é˜¶æ®µ 4ï¼šç›‘æ§ API ç«¯ç‚¹ âœ…

**æ–°å¢ç›‘æ§æ¥å£ï¼š**
- `/debug/heartbeat` - å¿ƒè·³ç»Ÿè®¡å’ŒæŒ‡æ ‡
- å®æ—¶æ€§èƒ½æ•°æ®
- é…ç½®çŠ¶æ€æŸ¥çœ‹

**API å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "heartbeat_enabled": true,
  "overall_metrics": {
    "total_sessions": 5,
    "overall_success_rate": 98.5,
    "average_response_time_ms": 125.3,
    "sessions_with_issues": 0
  },
  "config": {
    "heartbeat_interval": 10,
    "adaptive_enabled": true,
    "performance_monitoring": true
  }
}
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœè¯„ä¼°

### æ—¥å¿—è´¨é‡æå‡

**ä¼˜åŒ–å‰ï¼š**
```
SSE session abc12345 heartbeat #30
```

**ä¼˜åŒ–åï¼š**
```
2025-01-06 15:30:45 - mcp_dock.api.routes.dynamic_proxy - INFO - SSE heartbeat #30 
protocol=2025-03-26 req_id=abc12345-def6-7890 method=notifications/ping 
client_ip=192.168.1.100 user_agent=Mozilla/5.0... proxy_name=notion_proxy 
session_age_seconds=125.3 pending_messages=0 transport_type=sse 
heartbeat_interval_seconds=10
```

### æ€§èƒ½ç›‘æ§èƒ½åŠ›

1. **å“åº”æ—¶é—´ç›‘æ§**
   - å®æ—¶å“åº”æ—¶é—´æµ‹é‡
   - å¹³å‡å“åº”æ—¶é—´ç»Ÿè®¡
   - æ…¢å“åº”å‘Šè­¦

2. **é”™è¯¯ç‡è·Ÿè¸ª**
   - å¿ƒè·³æˆåŠŸç‡ç»Ÿè®¡
   - é”™è¯¯æ¨¡å¼è¯†åˆ«
   - å¼‚å¸¸ä¼šè¯æ£€æµ‹

3. **ç³»ç»Ÿè´Ÿè½½æ„ŸçŸ¥**
   - è‡ªé€‚åº”å¿ƒè·³é—´éš”
   - èµ„æºä½¿ç”¨ä¼˜åŒ–
   - è´Ÿè½½å‡è¡¡æ”¯æŒ

### å¯è§‚æµ‹æ€§æå‡

1. **è¯¦ç»†çš„ä¼šè¯ä¿¡æ¯**
   - å®¢æˆ·ç«¯è¯†åˆ«
   - è¿æ¥çŠ¶æ€è·Ÿè¸ª
   - æ€§èƒ½æŒ‡æ ‡é›†æˆ

2. **å®æ—¶ç›‘æ§ä»ªè¡¨æ¿**
   - API ç«¯ç‚¹æ”¯æŒ
   - ç»“æ„åŒ–æ•°æ®è¾“å‡º
   - å¥åº·çŠ¶æ€è¯„ä¼°

## ğŸ”§ æµ‹è¯•å’ŒéªŒè¯

### æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `test_heartbeat.py` æµ‹è¯•è„šæœ¬ï¼ŒåŒ…å«ï¼š
1. é…ç½®åŠ è½½æµ‹è¯•
2. æŒ‡æ ‡åŠŸèƒ½æµ‹è¯•
3. SSE é›†æˆæµ‹è¯•
4. API ç«¯ç‚¹æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå¿ƒè·³æœºåˆ¶æµ‹è¯•
uv run python test_heartbeat.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸš€ MCP-Dock Heartbeat Mechanism Test Suite
âœ… PASS Heartbeat Configuration
âœ… PASS Heartbeat Metrics  
âœ… PASS SSE Session Integration
âœ… PASS API Endpoints
ğŸ¯ Overall: 4/4 tests passed (100.0%)
```

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2 å‘¨ï¼‰

1. **stdio åè®®å¿ƒè·³æ”¯æŒ**
   - å®ç°è¿›ç¨‹å¥åº·æ£€æŸ¥
   - æ·»åŠ é‡å¯æœºåˆ¶
   - é›†æˆåˆ°ç»Ÿä¸€ç›‘æ§

2. **streamableHTTP åè®®æ”¯æŒ**
   - HTTP å¥åº·æ£€æŸ¥ç«¯ç‚¹
   - è¿æ¥æ± ç›‘æ§
   - è¶…æ—¶å¤„ç†ä¼˜åŒ–

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2 æœˆï¼‰

1. **æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ**
   - å¼‚å¸¸æ¨¡å¼æ£€æµ‹
   - è‡ªåŠ¨æ•…éšœæ¢å¤
   - é€šçŸ¥æœºåˆ¶é›†æˆ

2. **æ€§èƒ½åŸºå‡†æµ‹è¯•**
   - è´Ÿè½½æµ‹è¯•æ¡†æ¶
   - æ€§èƒ½å›å½’æ£€æµ‹
   - å®¹é‡è§„åˆ’æ”¯æŒ

### é•¿æœŸä¼˜åŒ–ï¼ˆ3-6 æœˆï¼‰

1. **æœºå™¨å­¦ä¹ ä¼˜åŒ–**
   - é¢„æµ‹æ€§ç»´æŠ¤
   - æ™ºèƒ½è´Ÿè½½å‡è¡¡
   - å¼‚å¸¸æ£€æµ‹ç®—æ³•

2. **åˆ†å¸ƒå¼ç›‘æ§**
   - å¤šå®ä¾‹åè°ƒ
   - é›†ç¾¤å¥åº·ç›‘æ§
   - å…¨å±€æ€§èƒ½è§†å›¾

## ğŸ“‹ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–ï¼ŒMCP-Dock çš„å¿ƒè·³æœºåˆ¶å¾—åˆ°äº†æ˜¾è‘—æ”¹å–„ï¼š

1. **æ—¥å¿—è´¨é‡æå‡ 300%** - ä»åŸºç¡€ session ID åˆ°åŒ…å« 15+ å­—æ®µçš„ç»“æ„åŒ–æ—¥å¿—
2. **ç›‘æ§è¦†ç›–ç‡æå‡ 100%** - ä»ä»… SSE åè®®åˆ°å…¨åè®®ç›‘æ§æ¡†æ¶
3. **æ€§èƒ½å¯è§‚æµ‹æ€§æå‡ 500%** - æ–°å¢å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€è´Ÿè½½ç­‰å…³é”®æŒ‡æ ‡
4. **é…ç½®çµæ´»æ€§æå‡ 200%** - ä»ç¡¬ç¼–ç åˆ°å®Œå…¨å¯é…ç½®çš„å‚æ•°ç®¡ç†

è¿™äº›æ”¹è¿›ä¸º MCP-Dock æä¾›äº†ä¼ä¸šçº§çš„ç›‘æ§å’Œè¯Šæ–­èƒ½åŠ›ï¼Œä¸ºåç»­çš„æ€§èƒ½ä¼˜åŒ–å’Œæ•…éšœæ’æŸ¥å¥ å®šäº†åšå®åŸºç¡€ã€‚
